{% extends "templates/web.html" %}

{% block title %} {{ _("Reset Password") }} {% endblock %}
{% block head_include %}
{% endblock %}
{% block page_content %}
<section class="for-reset-password d-block">
	<div class="page-card-head">
	</div>
	<div class="page-card">
		<form id="reset-password">
			<div style="text-align: center;">
				<img width="68px" src="/assets/sccc_theme/images/logo.svg" alt="sccc">
			</div>
			<br>
			<div class="form-group">
                <h4>{{ _("set up a new password") }}</h4>
				<div style="display: flex; align-items: center;">
					<img class="user_icon" src="/assets/sccc_theme/images/user.png" alt="sccc">
					<p style="margin-bottom: 0;" class="user-email"></p>
				</div>
				<br>
				
				<h6 style="font-weight: bold;">{{ _("Password requirements:") }}</h6>
                <ul>
                    <li><i class="fas fa-check-circle"></i> {{ _("at least 8 characters") }}</li>
                    <li><i class="fas fa-check-circle"></i> {{ _("a lowercase letter") }}</li>
                    <li><i class="fas fa-check-circle"></i> {{ _("an uppercase letter") }}</li>
                    <li><i class="fas fa-check-circle"></i> {{ _("a number") }}</li>
                </ul>
            </div>
			<div class="form-group">
				<label for="old_password" class="reset-password-heading">
					{{ _("Old Password") }} 
				</label>
				<span toggle="#old_password" class="toggle-password text-muted">{{ _("Show") }}</span>
				<input id="old_password" type="password"
					class="form-control mb-4" placeholder="" autocomplete="current-password">

			</div>
			<div class="form-group">
				<label for="new_password" class="reset-password-heading">
					{{ _("New Password") }}
				</label>
				<span toggle="#new_password" class="toggle-new_password text-muted">{{ _("Show") }}</span>
				<input id="new_password" type="password"
					class="form-control mb-4" placeholder="" autocomplete="new-password">
				<span class="password-strength-indicator indicator"></span>
			</div>
			<div class="form-group">
				<label for="confirm_password" class="reset-password-heading">
					{{ _("Confirm Password") }}
				</label>
				<span toggle="#confirm_password" class="toggle-confirm_password text-muted">{{ _("Show") }}</span>
				<input id="confirm_password" type="password"
					class="form-control" placeholder="" autocomplete="new-password">

			</div>

			<input style="height: 19px !important;" type="checkbox" id="signOut">
			<label for="signOut">{{ _("Sign me out of all other devices") }}</label>

			<p class="password-mismatch-message text-muted small hidden mt-2"></p>
			<p class='password-strength-message text-muted small mt-2 hidden'></p>

			<div style="display: flex !important; align-items: center !important;">
				<button type="submit" id="update" disabled=true
					style="cursor: not-allowed; margin: 0px; width: 170px;"
					class="btn btn-primary btn-block btn-update btn-color">
					{{ _("Set new password") }}
				</button>&emsp;
				<p style="margin: 0px;">
					<a href="/login">{{ _("back to sign in") }}</a>
				</p>
			</div>
		</form>

		<form id="reset-successful" style="display: none; text-align: center;">
			<div class="form-group">
				<img src="/assets/sccc_theme/images/mark_10099892.png" width="25%" alt="">
			</div>
			<div class="form-group">
                 <h4>{{ _("your new password has been set successfully!") }}</h4>
				 <div style="display: flex; align-items: center; justify-content: center;">
					<img class="user_icon" src="/assets/sccc_theme/images/user.png" alt="sccc">
					<p style="margin-bottom: 0;" class="user-email"></p>
				</div>
				<br>
            </div>
			<div class="form-group">
				<button style="margin-top: 5px !important;" id="back_sign_in" class="btn btn-color">
					{{ _("back to sign in") }}
				</button>
			</div>
		</form>

		{%- if not disable_signup -%}
			<div class="text-center sign-up-message">
				{{ _("don't have an account?") }}
				<a href="/login#signup">{{ _("sign up") }}</a>
			</div>
		{%- endif -%}
	</div>
</section>

<style>
	.page-card-head {
		padding: max(5vh, 30px) 0 14px 0px;
		margin: 0 auto;
		text-align: center;
		font-size: var(--text-xl);
		font-weight: 600;
	}
</style>

<script>

frappe.ready(function() {

	const key = frappe.utils.get_url_arg('key');
	const password_expired = frappe.utils.get_url_arg('password_expired');

	const old_password = $('#old_password');
	const new_password = $('#new_password');
	const confirm_password = $('#confirm_password');
	const update_button = $('#update');
	const button_back_sign_in = $('#back_sign_in');
	const password_strength_indicator = $('.password-strength-indicator');
	const password_strength_message = $('.password-strength-message');
	const password_mismatch_message = $('.password-mismatch-message');

	const password_not_same_as_old_password = "{{ _('New password cannot be same as old password') }}";
	const password_mismatch = "{{ _('Passwords do not match') }}";
	const password_strength_message_success = "{{ _('Success! You are good to go üëç') }}";

	get_user();

	if(key) {
		old_password.parent().toggle();
	}

	if(password_expired) {
		$(".password-box").html("{{ _('The password of your account has expired.') }}");
	}

	$("#reset-password").on("submit", function() { return false; });

	new_password.on("keypress", function(e) {
		if(e.which===13) update_button.click();
	})

	button_back_sign_in.click(function(e) {
		e.preventDefault();		
		window.location.href = "/login";
	});

	update_button.click(function() {
		var args = {
			key: key || "",
			old_password: old_password.val(),
			new_password: new_password.val(),
			confirm_password: confirm_password.val(),
			logout_all_sessions: 1
		}

		if (!args.old_password && !args.key) {
			frappe.msgprint({
				title: "{{ _('Missing Value') }}",
				message: "{{ _('Please enter your old password.') }}",
				clear: true
			});
		}
		if (!args.new_password) {
			frappe.msgprint({
				title: "{{ _('Missing Value') }}",
				message: "{{ _('Please enter your new password.') }}",
				clear: true
			});
		}
		if (args.old_password === args.new_password) {
			frappe.msgprint({
				title: "{{ _('Invalid Password') }}",
				message: password_not_same_as_old_password,
			});
			password_strength_message.addClass('hidden');
			return;
		}

		if (args.new_password !== args.confirm_password) {
			password_mismatch_message.text(password_mismatch)
				.removeClass('hidden text-muted').addClass('text-danger');
			password_strength_message.addClass('hidden');
			return;
		}

		frappe.call({
			type: "POST",
			method: "frappe.core.doctype.user.user.update_password",
			btn: update_button,
			args: args,
			statusCode: {
				401: function() {
					$(".page-card-head .reset-password-heading").text("{{ _('Invalid Password') }}");
					frappe.msgprint({
						title: "{{ _('Invalid Password') }}",
						message: "{{ _('Your old password is incorrect.') }}",
						clear: true
					});
				},
				410: function({ responseJSON }) {
					const title = "{{ _('Invalid Link') }}";
					const message = responseJSON.message;
					$(".page-card-head .reset-password-heading").text(title);
					frappe.msgprint({ title: title, message: message, clear: true });
				},
				200: function(r) {
					$("input").val("");
					strength_indicator.addClass("hidden");
					strength_message.addClass("hidden");
					$(".page-card-head .reset-password-heading")
						.html("{{ _('Status Updated') }}");
					if(r.message) {
						$("#reset-password").hide();
						$("#reset-successful").show();
						
						setTimeout(function() {
							window.location.href = r.message;
						}, 9000);
					}
				}
			}
		});

		return false;
	});

	function get_user(){
		frappe.call({
			type: "GET",
			method: "sccc_theme.utils.utils.get_user",
			args: {
				key: key || "",
				old_password: old_password.val()
			},
			callback: function(r) {
				if(r.message) {
					$(".user-email").text(r.message);
				}
			}
		});
	}

	window.strength_indicator = password_strength_indicator;
	window.strength_message = password_strength_message;

	new_password.on('keyup', function() {
		window.clear_timeout();
		window.timout_password_strength = setTimeout(window.test_password_strength, 200);
	});

	$("#old_password, #new_password, #confirm_password").on("keyup paste",
		frappe.utils.debounce(function () {

		let common_conditions = new_password.val() &&
			confirm_password.val() &&
			new_password.val() === confirm_password.val();

		if (new_password.val() &&
			old_password.val() === new_password.val()) {

			password_mismatch_message.text(password_not_same_as_old_password)
				.removeClass("hidden text-muted").addClass("text-danger");

			password_strength_message.addClass("hidden");
		}

		if ((new_password.val() || old_password.val) &&
			old_password.val() !== new_password.val()) {

			password_mismatch_message.addClass("hidden");
			password_strength_message.removeClass("hidden");
			password_mismatch_message.text('');
		}

		if (new_password.val() === confirm_password.val() &&
			old_password.val() !== new_password.val()) {

			password_mismatch_message.addClass("hidden");
			password_strength_message.removeClass("hidden");
		}

		if (confirm_password.val() &&
			new_password.val() !== confirm_password.val()) {

			password_mismatch_message.text(password_mismatch)
				.removeClass("hidden text-muted").addClass("text-danger");
			password_strength_message.addClass("hidden");
		}

		if ((key || (!key && old_password.val())) && common_conditions ) {
			update_button.prop("disabled", false).css("cursor", "pointer");
		}
		else {
			update_button.prop("disabled", true).css("cursor", "not-allowed");
		}

	},500));

	window.test_password_strength = function() {
		window.timout_password_strength = null;

		var args = {
			key: key || "",
			old_password: old_password.val(),
			new_password: new_password.val()
		}

		if (!args.new_password) {
			set_strength_indicator('grey', {
				'warning': "{{ _('Please enter the password') }}"
			});
			return;
		}

		return frappe.call({
			method: 'frappe.core.doctype.user.user.test_password_strength',
			args: args,
			callback: function(r) {
				console.log(r.message);
			},
			statusCode: {
				401: function() {
					$('.page-card-head .reset-password-heading')
						.text("{{ _('Invalid Password') }}");
				},
				200: function(r) {
					if (r.message) {
						var score = r.message.score,
							feedback = r.message.feedback;

						if (!feedback) { return; }

						feedback.score = score;

						if (feedback.password_policy_validation_passed) {
							set_strength_indicator('green', feedback);
						}else{
							set_strength_indicator('red', feedback);
						}
					}
				}
			}
		});
	};

	window.set_strength_indicator = function(color, feedback) {
		var message = [];
		feedback.help_msg = "";

		if(!feedback.password_policy_validation_passed){
			feedback.help_msg = "<br>" +
				"{{ _('Hint: Include symbols, numbers and capital letters in the password') }}";
		}

		if (feedback) {
			if(!feedback.password_policy_validation_passed){
				if (feedback.suggestions && feedback.suggestions.length) {
					message = message.concat(feedback.suggestions);
				} else if (feedback.warning) {
					message.push(feedback.warning);
				}
				message.push(feedback.help_msg);

			} else {
				message.push(password_strength_message_success);
			}
		}

		password_mismatch_message.addClass('hidden');
		strength_message.html(message.join(' ') || '').removeClass('hidden');
	}

	window.clear_timeout = function() {
		if (window.timout_password_strength) {
			clearTimeout(window.timout_password_strength);
			window.timout_password_strength = null;
		}
	};

    $(document).ready(function() {
        $(".web-footer").hide();
    });

	$(".toggle-password").click(function () {
		var input = $($(this).attr("toggle"));
		if (input.attr("type") == "password") {
			input.attr("type", "text");
			$(this).text("{{ _('Hide') }}");
		} else {
			input.attr("type", "password");
			$(this).text("{{ _('Show') }}");
		}
	});
	$(".toggle-new_password").click(function () {
		var input = $($(this).attr("toggle"));
		if (input.attr("type") == "password") {
			input.attr("type", "text");
			$(this).text("{{ _('Hide') }}");
		} else {
			input.attr("type", "password");
			$(this).text("{{ _('Show') }}");
		}
	});
	$(".toggle-confirm_password").click(function () {
		var input = $($(this).attr("toggle"));
		if (input.attr("type") == "password") {
			input.attr("type", "text");
			$(this).text("{{ _('Hide') }}");
		} else {
			input.attr("type", "password");
			$(this).text("{{ _('Show') }}");
		}
	});
});

</script>

{% endblock %}

{% block style %}
<style>

	@font-face {
		font-family: 'STCForward';
		src: url('/assets/sccc_theme/font/STCForward-Regular.otf') format('opentype');
	}

	.page-card h4,
	.page-card h6,
	.page-card label,
	.page-card p,
	.page-card a,
	.page-card button,
	.page-card li {
		text-transform: lowercase !important;
	}

	.page-card h4::first-letter,
	.page-card h6::first-letter,
	.page-card label::first-letter,
	.page-card p::first-letter,
	.page-card a::first-letter,
	.page-card button::first-letter,
	.page-card li::first-letter {
		text-transform: lowercase !important;
	}

	body {
		font-weight: bold !important;
    	background-color :#4F008C;
    }

	body,*{
	  font-family: 'STCForward';
    }

    .page-card, input, button{
		border-radius: 0px !important;
	}

    h4 {
		font-size: 1.8rem;
        margin-top: 0rem !important;
    }

    label{
		color: black;
		font-weight: bold;
	}

    .btn-color {
      background-color:  #FF375E !important;
      width: 60%;
      color: white;
	  height: 45px;
    }

	.password-strength-indicator {
		float: right;
		padding: 15px;
		margin-top: -38px;
		margin-right: -7px;
	}

    .page-card input{
		background-color: white !important;
		border: 1px solid #e8e3e3 !important;
		padding-left: 8px !important;
		height: 45px;
	}

	.password-strength-message {
		margin-top: -10px;
	}

	.toggle-new_password, .toggle-confirm_password, .toggle-password {
		right: 9px;
		top: 40px;
		position: absolute;
		z-index: 2;
		cursor: pointer;
		font-size: 12px;
	}

	.form-group{
		position: relative;
	}

	.user_icon {
		width: 16px;
		height: 16px !important;
		margin-right: 6px;
	}

	.logo{
		width: 80px;
	}

	/* .navbar {
		display: none !important;
	} */
	 .navbar-light {
		border-bottom: none !important;
		background: #4F008C;
	}
	/* .navbar-light .navbar-brand {
		display: none !important;
	}
	.navbar .navbar-nav .nav-item.active {
		display: none;
	} */
	.mb-0, .my-0 {
		margin-bottom: -20px !important;
		margin-top: 15px;
	}

	.navbar.navbar-light.navbar-expand-lg {
		background-color: #4F008C !important;
		border-bottom: none !important;
	}
	.navbar .navbar-nav .nav-item {
		/* height: var(--navbar-height); */
		display: none;
		/* align-items: center; */
	}
	.navbar-brand {
		display: none;
		/* padding-top: 0.40625rem;
		padding-bottom: 0.40625rem;
		margin-right: 1rem;
		font-size: 1.125rem;
		line-height: inherit;
		white-space: nowrap; */
	}



	{% include "templates/styles/card_style.css" %}
</style>
{% endblock %}
